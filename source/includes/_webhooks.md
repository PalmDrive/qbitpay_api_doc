# Webhooks

## Webhooks

> Example object

```json
{
  "id": "fDOuTy95uSiTi",
  "type": "charge.succeeded",
  "createdAt": "2019-02-25T16:13:12.278Z",
  "object": "event",
  "pendingWebhooks": 0,
  "livemode": true,
  "data": {
    "id": "ifDOu5uTSTy9i",
    "object": "charge",
    "createdAt": "2019-02-23T16:13:12.278Z",
    "paid": false,
    "status": "pending",
    "amount": 100,
    "totalCost": 676,
    "price": 38737.7,
    "fee": 0,
    "baseAmount": 0.017451,
    "currency": "USD",
    "quoteCurrency": "CNY",
    "baseCurrency": "BTC",
    "externalOrderId": "DTSifOuTy95ui",
    "paymentPageUrl": "https://qbitpay.blockscape.co/?zh#/otc/payment?tradeId=uTifOuTy95DTSifOy95",
    "cbUrl": "https://api.blockscape.co",
    "redirectUrl": "https://qbitpay.blockscape.co",
    "paymentMethod": {
      "object": "paymentMethod",
      "alipayQRCodeUrl": "https://alipay.net.com/qrcode",
      "type": "Alipay",
      "currency": "CNY",
      "status": "active",
      "typeLabel": {
        "en": "Alipay",
        "zh": "支付宝"
      }
    }
  }
}
```

QbitPay supports Webhook that pushes the event notification to the url configured by the developer.

- the notification is pushed using POST with JSON format. The event data is included in the response body.
- after receiving the Webhook notification, you need send response to the server. 2xx is for success and 500 is for failure.
- if the server doesn't receive 2xx response, it will try to send the notifiaction repeatedly up to 5 times every 15 mins. It keeps trying until receiving 2xx response or reaching the max number of retries.

Event object is defined as below

field	    |     desc
--------  | -----------
id *string* | ID generated by QbitPay
type *string* | event type
object *string* | value is 'event'
createdAt *string* | timestamp when created in UTC timezone
pendingWebhooks *int* | the number of unsuccessfuly pushed notifications
livemode *boolean* | true when in production mode
data *hash* | the object data related to the event

## Signature verification

The signed signature is in the `QbitPay-Signature` field in the request header. You should always verify this signature to prevent from fund loss.

### Signature signing algo

> Data example

```json
{
  "id": "fDOuTy95uSiTi",
  "type": "charge.succeeded",
  "createdAt": "2019-02-25T16:13:12.278Z",
  "object": "event",
  "pendingWebhooks": 0,
  "livemode": true,
  "data": {
    "id": "5",
    "object": "charge",
    "createdAt": "2019-02-25T16:13:12.278Z",
    "paid": false,
    "status": "pending",
    "amount": 1000,
    "currency": "USD",
    "externalOrderId": "DTSifOuTy95ui",
    "paymentPageUrl": "https://qbitpay.blockscape.co/?zh#/otc/payment?tradeId=DTSifOuTy95ifOuTy95",
    "cbUrl": "https://api.blockscape.co",
    "redirectUrl": "https://qbitpay.blockscape.co"
  }
}
```

> Convert the data to string：createdAt=2019-02-25T16:13:12.278Z&data={"id":"5","o
bject":"charge","createdAt":"2019-02-25T16:13:12.278Z","paid":false,"status":"pending","amount":1000,"currency":"
USD","externalOrderId":"DTSifOuTy95ui","paymentPageUrl":"https://qbitpay.blockscape.co/?zh#/otc/payment?tradeId=D
TSifOuTy95ifOuTy95","cbUrl":"https://api.blockscape.co","redirectUrl":"https://qbitpay.blockscape.co"}&id=fDOuTy9
5uSiTi&livemode=true&object=event&pendingWebhooks=0&type=charge.succeeded

> If use api key "T9uTy95uSifOOuTy" to sign, will get "EE53810FF1341779F2FF25989A67DCFC"

> Second step of signing signature example

```javascript
stringSignTemp=stringA+"&key=T9uTy95uSifOOuTy"
//notes：key is the api key

sign=MD5(stringSignTemp).toUpperCase()
="9A0A8659F005D6984697E2CA0A9CF3B7"
//notes：MD5 sign

sign=hash_hmac("sha256", stringSignTemp, key).toUpperCase()
="6A9AE1657590FD6257D693A078E1C3E4BB6BA4DC30B23E0EE2496E54170DACD6"
//notes：HMAC-SHA256 sign
```

First, sort the params by the non-empty key's ASCII in the ascending order and concatenate into stringA with URL key-value format(i.e. key1=value1&key2=value2…).

Please notice these important rules:

- Sort the params by the key's ASCII in the ascending order
- The param with empty value is ignored
- The param keys are case insensitive
- If the value is hash, stringify the hash with the same rules described above.

Second, append api key to stringA and get stringSignTemp. MD5 Encode stringSignTemp, convert all characters to uppercasee to get signValue.

## Debug

> Request example

```shell
curl "https://api.qbitnetwork.com/api/v1/events/test?cbUrl=https://api.blockscape.co",
  -u "my_api_key:"
```

> Notification data

```json
{
  "id": "fDOuTy95uSiTi",
  "type": "charge.succeeded",
  "createdAt": "2019-02-25T16:13:12.278Z",
  "object": "event",
  "pendingWebhooks": 0,
  "livemode": false,
  "data": {
    "id": "ifDOu5uTSTy9i",
    "object": "charge",
    "createdAt": "2019-02-23T16:13:12.278Z",
    "paid": false,
    "status": "pending",
    "amount": 100,
    "totalCost": 676,
    "price": 38737.7,
    "fee": 0,
    "baseAmount": 0.017451,
    "currency": "USD",
    "quoteCurrency": "CNY",
    "baseCurrency": "BTC",
    "externalOrderId": "DTSifOuTy95ui",
    "paymentPageUrl": "https://qbitpay.blockscape.co/?zh#/otc/payment?tradeId=uTifOuTy95DTSifOy95",
    "cbUrl": "https://api.blockscape.co",
    "redirectUrl": "https://qbitpay.blockscape.co",
    "paymentMethod": {
      "object": "paymentMethod",
      "alipayQRCodeUrl": "https://alipay.net.com/qrcode",
      "type": "Alipay",
      "currency": "CNY",
      "status": "active",
      "typeLabel": {
        "en": "Alipay",
        "zh": "支付宝"
      }
    }
  }
}
```

QbitPay provides API to debug Webhooks。 Make request to `https://api.qbitnetwork.com/api/v1/events/test` and get an event notification for test， which livemode is false. Please notes that it will not retry if the server doesn't receive 2xx response. The callback URL cbUrl could be also included in the params.

The event notificaiton will be pushed with POST method to the URL configured by the developer signed with the api key.
